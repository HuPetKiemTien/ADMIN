<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Coin Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Import Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 z-50 bg-slate-950 flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-indigo-600/20 text-indigo-500 rounded-full flex items-center justify-center text-3xl mx-auto mb-4">
                <i class="fa-solid fa-user-shield"></i>
            </div>
            <h2 class="text-2xl font-bold text-white mb-6">Supabase Admin</h2>
            <input type="password" id="admin-pass" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 mb-4 text-white focus:outline-none focus:border-indigo-500" placeholder="Mật khẩu: admin123">
            <button onclick="attemptLogin()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg transition-colors">ĐĂNG NHẬP</button>
            <p id="login-msg" class="text-rose-500 text-sm mt-3 hidden"></p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" class="hidden h-full flex flex-col md:flex-row">
        
        <!-- Sidebar -->
        <aside class="w-full md:w-64 bg-slate-900 border-r border-slate-800 flex flex-col shrink-0">
            <div class="h-16 flex items-center px-6 border-b border-slate-800 gap-3">
                <i class="fa-brands fa-bitcoin text-yellow-500 text-2xl"></i>
                <span class="font-bold text-lg tracking-wide text-white">CoinAdmin</span>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item w-full text-left px-4 py-3 rounded-lg bg-indigo-600/10 text-indigo-400 font-medium border border-indigo-600/20">
                    <i class="fa-solid fa-chart-line w-6"></i> Dashboard
                </button>
                <button onclick="switchTab('codes')" id="nav-codes" class="nav-item w-full text-left px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-colors">
                    <i class="fa-solid fa-ticket w-6"></i> Mã Nạp Tiền
                </button>
                <button onclick="switchTab('withdraws')" id="nav-withdraws" class="nav-item w-full text-left px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-colors">
                    <i class="fa-solid fa-money-bill-transfer w-6"></i> Duyệt Rút Tiền
                </button>
                <button onclick="switchTab('users')" id="nav-users" class="nav-item w-full text-left px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-colors">
                    <i class="fa-solid fa-users-gear w-6"></i> Quản Lý User
                </button>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden bg-slate-950 relative">
            <header class="h-16 bg-slate-900/50 backdrop-blur border-b border-slate-800 flex items-center justify-between px-6 shrink-0">
                <h2 id="page-title" class="text-xl font-bold text-white">Tổng quan</h2>
                <button onclick="initData()" class="bg-slate-800 hover:bg-slate-700 text-white px-3 py-1.5 rounded text-xs flex items-center gap-2">
                    <i class="fa-solid fa-sync"></i> Làm mới
                </button>
            </header>

            <div class="flex-1 overflow-y-auto p-6 space-y-6" id="main-content">
                
                <!-- DASHBOARD -->
                <div id="view-dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-slate-900 border border-slate-800 p-6 rounded-xl relative overflow-hidden">
                        <div class="text-slate-400 text-sm font-medium uppercase mb-1">Mã nạp Active</div>
                        <div class="text-3xl font-bold text-white" id="stat-codes">--</div>
                    </div>
                    <div class="bg-slate-900 border border-slate-800 p-6 rounded-xl relative overflow-hidden">
                        <div class="text-slate-400 text-sm font-medium uppercase mb-1">Đơn rút chờ duyệt</div>
                        <div class="text-3xl font-bold text-yellow-400" id="stat-pending">--</div>
                    </div>
                    <div class="bg-slate-900 border border-slate-800 p-6 rounded-xl relative overflow-hidden">
                        <div class="text-slate-400 text-sm font-medium uppercase mb-1">Trạng thái</div>
                        <div class="text-lg font-bold text-emerald-400">Online</div>
                    </div>
                </div>

                <!-- CODES -->
                <div id="view-codes" class="hidden space-y-6">
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-6">
                        <h3 class="text-lg font-bold text-white mb-4">Tạo mã mới</h3>
                        <div class="flex flex-wrap gap-4">
                            <input id="code-amount" type="number" placeholder="Giá trị (Coin)" class="bg-slate-800 border border-slate-700 text-white rounded px-4 py-2 flex-1">
                            <input id="code-max" type="number" placeholder="Lượt dùng" value="1" class="bg-slate-800 border border-slate-700 text-white rounded px-4 py-2 w-32">
                            <button onclick="createNewCode()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-2 rounded font-bold">Tạo</button>
                        </div>
                    </div>
                    <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
                        <table class="w-full text-left text-sm text-slate-300">
                            <thead class="bg-slate-800 text-slate-400 text-xs uppercase">
                                <tr><th class="p-4">Mã</th><th class="p-4">Giá trị</th><th class="p-4">Dùng</th><th class="p-4">Xóa</th></tr>
                            </thead>
                            <tbody id="table-codes"></tbody>
                        </table>
                    </div>
                </div>

                <!-- WITHDRAWS -->
                <div id="view-withdraws" class="hidden space-y-6">
                    <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
                         <div class="p-4 border-b border-slate-800"><h3 class="font-bold text-white">Yêu cầu rút tiền</h3></div>
                         <div id="withdraw-list" class="divide-y divide-slate-800"></div>
                    </div>
                </div>

                <!-- USERS -->
                <div id="view-users" class="hidden space-y-6">
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 max-w-xl mx-auto">
                        <h3 class="text-lg font-bold text-white mb-4">Cộng/Trừ tiền User</h3>
                        <div class="space-y-4">
                            <input id="edit-uid" type="text" placeholder="UID User" class="w-full bg-slate-800 border border-slate-700 text-white rounded px-4 py-3">
                            <input id="edit-balance" type="number" placeholder="Số dư MỚI (Ví dụ: 50000)" class="w-full bg-slate-800 border border-slate-700 text-white rounded px-4 py-3">
                            <button onclick="updateUserBalance()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded font-bold">CẬP NHẬT</button>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-5 right-5 bg-slate-800 border border-slate-600 text-white px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 transition-all duration-300 opacity-0 translate-x-10 z-50">
        <i id="toast-icon" class="fa-solid fa-check text-emerald-500"></i>
        <span id="toast-msg">Thông báo</span>
    </div>

    <script>
        // ==== CONFIG ====
        const SUPABASE_URL = "https://boddppngzdgpazrrdual.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvZGRwcG5nemRncGF6cnJkdWFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNTk5ODAsImV4cCI6MjA4MDkzNTk4MH0.rdNoq5qlmXzH3AafSxZOwv6qJznWhs8J_LHmdu0NT44";
        const ADMIN_PASS = "admin123";

        // Init Supabase Client
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        // ==== LOGIC ĐĂNG NHẬP ====
        function attemptLogin() {
            const passInput = document.getElementById("admin-pass").value;
            const msg = document.getElementById("login-msg");
            
            if (passInput === ADMIN_PASS) {
                document.getElementById("login-overlay").classList.add("hidden");
                document.getElementById("app-container").classList.remove("hidden");
                initData(); // Tải dữ liệu ngay khi đăng nhập
            } else {
                msg.textContent = "Sai mật khẩu! Vui lòng thử lại.";
                msg.classList.remove("hidden");
                // Rung nhẹ input
                const input = document.getElementById("admin-pass");
                input.classList.add("border-rose-500");
                setTimeout(() => input.classList.remove("border-rose-500"), 500);
            }
        }

        // Allow Enter key to login
        document.getElementById("admin-pass").addEventListener("keypress", function(event) {
            if (event.key === "Enter") attemptLogin();
        });

        // ==== LOGIC DATA ====
        
        // 1. Load Tất cả Data
        async function initData() {
            loadStats();
            loadCodes();
            loadWithdraws();
        }

        // 2. Stats
        async function loadStats() {
            try {
                const { count: pCount } = await db.from("withdraw_request").select("*", { count: 'exact', head: true }).eq("status", "pending");
                const { count: cCount } = await db.from("codes_deposit").select("*", { count: 'exact', head: true });
                
                document.getElementById("stat-pending").innerText = pCount || 0;
                document.getElementById("stat-codes").innerText = cCount || 0;
            } catch (e) { console.error("Stats error", e); }
        }

        // 3. Codes
        async function loadCodes() {
            const { data, error } = await db.from("codes_deposit").select("*").order("id", {ascending: false}).limit(20);
            const tbody = document.getElementById("table-codes");
            tbody.innerHTML = "";
            
            if (data && data.length) {
                data.forEach(c => {
                    tbody.innerHTML += `
                        <tr class="hover:bg-slate-800/50 border-b border-slate-800">
                            <td class="p-4 font-mono font-bold text-white">${c.code}</td>
                            <td class="p-4 text-emerald-400 font-bold">${c.value.toLocaleString()}</td>
                            <td class="p-4 text-slate-400">${c.used_count}/${c.max_use}</td>
                            <td class="p-4"><button onclick="deleteCode('${c.code}')" class="text-rose-500 hover:text-white"><i class="fa-solid fa-trash"></i></button></td>
                        </tr>`;
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center italic text-slate-500">Chưa có mã nào</td></tr>`;
            }
        }

        async function createNewCode() {
            const val = parseInt(document.getElementById("code-amount").value);
            const max = parseInt(document.getElementById("code-max").value);
            if (!val) return showToast("Nhập số tiền!", "error");
            
            const code = Math.random().toString(36).substr(2,6).toUpperCase();
            const { error } = await db.from("codes_deposit").insert({
                code: code, value: val, max_use: max || 1, used_count: 0, expired: false
            });

            if (error) showToast("Lỗi tạo mã", "error");
            else {
                showToast(`Đã tạo: ${code}`, "success");
                loadCodes();
                loadStats();
            }
        }

        async function deleteCode(code) {
            if(!confirm("Xóa mã này?")) return;
            await db.from("codes_deposit").delete().eq("code", code);
            loadCodes();
        }

        // 4. Withdraws
        async function loadWithdraws() {
            const { data } = await db.from("withdraw_request").select("*").eq("status", "pending").order("time_request", {ascending: false});
            const list = document.getElementById("withdraw-list");
            list.innerHTML = "";

            if (data && data.length) {
                data.forEach(w => {
                    list.innerHTML += `
                        <div class="p-4 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div class="flex-1">
                                <div class="text-white font-bold text-lg">${w.amount.toLocaleString()} Coin</div>
                                <div class="text-xs text-slate-400">UID: ${w.uid} | Bank: ${w.bank_name} - ${w.bank_account}</div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="processWithdraw('${w.id}', true)" class="bg-emerald-600 text-white px-3 py-1 rounded text-sm font-bold">Duyệt</button>
                                <button onclick="processWithdraw('${w.id}', false, '${w.uid}', ${w.amount})" class="bg-rose-600 text-white px-3 py-1 rounded text-sm font-bold">Hủy</button>
                            </div>
                        </div>`;
                });
            } else {
                list.innerHTML = `<div class="p-4 text-center text-slate-500 italic">Không có yêu cầu nào</div>`;
            }
        }

        async function processWithdraw(id, isApprove, uid, amount) {
            if (isApprove) {
                if(!confirm("Duyệt đơn này?")) return;
                await db.from("withdraw_request").update({ status: "approved", time_done: new Date().toISOString() }).eq("id", id);
                showToast("Đã duyệt", "success");
            } else {
                if(!confirm("Từ chối và Hoàn tiền?")) return;
                // Hoàn tiền
                const { data: u } = await db.from("users").select("balance").eq("id", uid).single();
                if(u) {
                    await db.from("users").update({ balance: (u.balance || 0) + amount }).eq("id", uid);
                    await db.from("withdraw_request").update({ status: "rejected", time_done: new Date().toISOString() }).eq("id", id);
                    showToast("Đã hủy & hoàn tiền", "success");
                } else {
                    showToast("Không tìm thấy user", "error");
                }
            }
            loadWithdraws();
            loadStats();
        }

        // 5. Users
        async function updateUserBalance() {
            const uid = document.getElementById("edit-uid").value.trim();
            const bal = parseInt(document.getElementById("edit-balance").value);
            if (!uid || isNaN(bal)) return showToast("Nhập thông tin hợp lệ", "error");

            // Check if user exists
            const { data: user } = await db.from("users").select("id").eq("id", uid).maybeSingle();
            
            let err;
            if (!user) {
                // Insert
                const { error } = await db.from("users").insert({ id: uid, balance: bal });
                err = error;
            } else {
                // Update
                const { error } = await db.from("users").update({ balance: bal }).eq("id", uid);
                err = error;
            }

            if (err) showToast("Lỗi cập nhật", "error");
            else showToast("Cập nhật thành công", "success");
        }

        // ==== UTILS ====
        function switchTab(id) {
            ['dashboard', 'codes', 'withdraws', 'users'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                document.getElementById(`nav-${t}`).classList.remove('bg-indigo-600/10', 'text-indigo-400');
                document.getElementById(`nav-${t}`).classList.add('text-slate-400');
            });
            document.getElementById(`view-${id}`).classList.remove('hidden');
            document.getElementById(`nav-${id}`).classList.add('bg-indigo-600/10', 'text-indigo-400');
            document.getElementById(`nav-${id}`).classList.remove('text-slate-400');
            
            const titles = {'dashboard': 'Tổng quan', 'codes': 'Quản lý Mã', 'withdraws': 'Duyệt Rút', 'users': 'User'};
            document.getElementById('page-title').innerText = titles[id];
            
            if(id !== 'dashboard') initData();
        }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            document.getElementById('toast-icon').className = type === 'error' ? "fa-solid fa-circle-exclamation text-rose-500" : "fa-solid fa-check text-emerald-500";
            t.classList.remove('opacity-0', 'translate-x-10');
            setTimeout(() => t.classList.add('opacity-0', 'translate-x-10'), 3000);
        }

    </script>
</body>
</html>

