<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CoinAdmin V7 - Secure Logic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; -webkit-tap-highlight-color: transparent; }
        .font-mono { font-family: 'Space Mono', monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .nav-item.active { color: #3b82f6; }
        .nav-item.active i { transform: translateY(-3px); color: #3b82f6; }
        .nav-item { transition: all 0.2s; color: #64748b; }
        
        /* Loading overlay khi đang xử lý */
        .card-processing { opacity: 0.5; pointer-events: none; position: relative; }
        .card-processing::after {
            content: "\f1ce"; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            animation: spin 1s linear infinite; font-size: 24px; color: white;
        }
        @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-slate-950">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-slate-950 flex flex-col items-center justify-center p-6">
        <div class="w-20 h-20 bg-blue-600/20 text-blue-500 rounded-2xl flex items-center justify-center text-4xl mb-6 shadow-2xl shadow-blue-500/20">
            <i class="fa-solid fa-user-shield"></i>
        </div>
        <h2 class="text-2xl font-bold text-white mb-2">Admin Portal</h2>
        <input type="password" id="admin-pass" class="w-full max-w-xs bg-slate-900 border border-slate-800 text-white text-center rounded-xl px-4 py-4 text-lg mb-4 focus:outline-none focus:border-blue-500 transition-colors" placeholder="Nhập mật khẩu quản trị">
        <button onclick="handleLogin()" class="w-full max-w-xs bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-transform">ĐĂNG NHẬP</button>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="hidden flex-1 flex flex-col h-full relative">
        <!-- HEADER -->
        <header class="h-16 flex items-center justify-between px-5 bg-slate-900/90 backdrop-blur fixed top-0 w-full z-40 border-b border-slate-800">
            <h1 id="page-title" class="font-bold text-lg text-white">Tổng quan</h1>
            <button onclick="loadAllData()" class="w-9 h-9 rounded-full bg-slate-800 text-slate-400 flex items-center justify-center active:bg-slate-700 transition-colors"><i class="fa-solid fa-rotate-right"></i></button>
        </header>

        <!-- CONTENT -->
        <main class="flex-1 overflow-y-auto no-scrollbar pt-20 pb-24 px-4 space-y-6">
            
            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="space-y-5 fade-in">
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-5 shadow-lg">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4 border-b border-slate-800 pb-2">Dòng Tiền Hệ Thống</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-emerald-500/10 flex items-center justify-center text-emerald-500"><i class="fa-solid fa-arrow-trend-up"></i></div>
                                <div><p class="text-xs text-slate-400">Tổng Nạp (Giftcode)</p><p class="font-bold text-white text-lg" id="money-in">0</p></div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-rose-500/10 flex items-center justify-center text-rose-500"><i class="fa-solid fa-arrow-trend-down"></i></div>
                                <div><p class="text-xs text-slate-400">Tổng Rút (Đã duyệt)</p><p class="font-bold text-white text-lg" id="money-out">0</p></div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between pt-2 border-t border-slate-800/50">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-500"><i class="fa-solid fa-wallet"></i></div>
                                <div><p class="text-xs text-slate-400">Tổng Số Dư User</p><p class="font-bold text-blue-400 text-lg" id="money-holding">0</p></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-900 border border-slate-800 p-5 rounded-2xl">
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1">Đơn Chờ Duyệt</p>
                        <h3 class="text-3xl font-bold text-yellow-500" id="stat-pending">--</h3>
                    </div>
                    <div class="bg-slate-900 border border-slate-800 p-5 rounded-2xl">
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1">Tổng User</p>
                        <h3 class="text-3xl font-bold text-slate-200" id="stat-users">--</h3>
                    </div>
                </div>
            </div>

            <!-- VIEW: CODES -->
            <div id="view-codes" class="hidden space-y-5 fade-in">
                <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800 space-y-4 shadow-lg sticky top-0 z-30">
                    <div class="flex items-center gap-2 border-b border-slate-800 pb-3">
                        <div class="w-8 h-8 rounded-full bg-emerald-500/20 text-emerald-500 flex items-center justify-center"><i class="fa-solid fa-ticket text-sm"></i></div>
                        <h3 class="font-bold text-white text-sm">Tạo Giftcode Mới</h3>
                    </div>
                    <div class="grid grid-cols-12 gap-3">
                        <div class="col-span-8">
                            <label class="text-[10px] text-slate-500 font-bold uppercase ml-1 mb-1 block">Giá trị Coin</label>
                            <input id="code-amount" type="tel" oninput="formatInput(this)" class="w-full bg-slate-950 border border-slate-800 text-white rounded-xl px-4 py-3 text-sm font-bold placeholder-slate-600 focus:border-emerald-500 outline-none transition-colors" placeholder="VD: 50,000">
                        </div>
                        <div class="col-span-4">
                            <label class="text-[10px] text-slate-500 font-bold uppercase ml-1 mb-1 block text-center">Số lượng</label>
                            <input id="code-max" type="number" value="1" class="w-full bg-slate-950 border border-slate-800 text-white rounded-xl px-2 py-3 text-center text-sm font-bold focus:border-emerald-500 outline-none transition-colors">
                        </div>
                    </div>
                    <button onclick="createDepositCode()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-emerald-900/20 active:scale-[0.98] transition-transform flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus"></i> TẠO NGAY
                    </button>
                </div>
                <div class="space-y-3" id="list-codes"></div>
            </div>

            <!-- VIEW: WITHDRAW -->
            <div id="view-withdraw" class="hidden space-y-4 fade-in">
                <div class="flex items-center justify-between px-1">
                    <p class="text-xs text-slate-500 font-bold uppercase tracking-wider">Danh sách chờ duyệt</p>
                    <span class="text-xs text-slate-600" id="withdraw-count">0 đơn</span>
                </div>
                <div class="space-y-4" id="list-withdraws"></div>
            </div>

            <!-- VIEW: USERS -->
            <div id="view-users" class="hidden space-y-6 fade-in">
                <div class="bg-slate-900 p-6 rounded-2xl border border-slate-800 text-center space-y-5 shadow-xl">
                    <div class="w-16 h-16 bg-indigo-500/10 text-indigo-500 rounded-full flex items-center justify-center text-3xl mx-auto border-2 border-indigo-500/20">
                        <i class="fa-solid fa-money-bill-transfer"></i>
                    </div>
                    <h3 class="text-white font-bold text-lg">Giao Dịch Người Dùng</h3>
                    <div class="space-y-4 text-left">
                        <div>
                            <label class="text-[10px] text-slate-500 font-bold uppercase ml-1 mb-1 block">ID Người dùng</label>
                            <div class="relative">
                                <span class="absolute left-4 top-3.5 text-slate-500"><i class="fa-solid fa-user"></i></span>
                                <input id="adjust-uid" type="text" class="w-full bg-slate-950 border border-slate-800 text-white rounded-xl pl-10 pr-4 py-3.5 focus:border-indigo-500 outline-none font-mono uppercase placeholder-slate-700" placeholder="NHAP-USER-ID">
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 font-bold uppercase ml-1 mb-1 block">Số tiền giao dịch</label>
                            <input id="adjust-amount" type="tel" oninput="formatInput(this)" class="w-full bg-slate-950 border border-slate-800 text-white rounded-xl px-4 py-3.5 focus:border-indigo-500 outline-none font-bold text-lg placeholder-slate-700 text-center" placeholder="0">
                        </div>
                        <div class="grid grid-cols-2 gap-3 pt-2">
                            <button onclick="adjustBalance('subtract')" class="flex flex-col items-center justify-center py-4 rounded-xl bg-rose-950/40 border border-rose-500/30 text-rose-500 hover:bg-rose-900/50 active:scale-[0.98] transition-all group">
                                <span class="text-xs font-bold uppercase mb-1 opacity-70 group-hover:opacity-100">Trừ tiền</span>
                                <i class="fa-solid fa-minus text-xl font-bold"></i>
                            </button>
                            <button onclick="adjustBalance('add')" class="flex flex-col items-center justify-center py-4 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg shadow-emerald-900/30 active:scale-[0.98] transition-all">
                                <span class="text-xs font-bold uppercase mb-1 opacity-90">Nạp tiền</span>
                                <i class="fa-solid fa-plus text-xl font-bold"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- NAV BAR -->
        <nav class="bg-slate-900/95 backdrop-blur border-t border-slate-800 h-[80px] fixed bottom-0 w-full flex justify-around items-center z-50 pb-4 pt-1">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item active flex flex-col items-center w-16 gap-1 p-2 rounded-xl"><i class="fa-solid fa-chart-pie text-xl"></i><span class="text-[10px] font-medium">Dash</span></button>
            <button onclick="switchTab('codes')" id="nav-codes" class="nav-item flex flex-col items-center w-16 gap-1 p-2 rounded-xl"><i class="fa-solid fa-ticket text-xl"></i><span class="text-[10px] font-medium">Code</span></button>
            <button onclick="switchTab('withdraw')" id="nav-withdraw" class="nav-item flex flex-col items-center w-16 gap-1 p-2 rounded-xl relative"><i class="fa-solid fa-money-bill-wave text-xl"></i><span class="text-[10px] font-medium">Rút tiền</span><span id="badge-withdraw" class="hidden absolute top-2 right-3 w-2.5 h-2.5 bg-rose-500 rounded-full border border-slate-900"></span></button>
            <button onclick="switchTab('users')" id="nav-users" class="nav-item flex flex-col items-center w-16 gap-1 p-2 rounded-xl"><i class="fa-solid fa-user-gear text-xl"></i><span class="text-[10px] font-medium">User</span></button>
        </nav>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-6 right-1/2 translate-x-1/2 w-max max-w-[90%] bg-slate-800 border border-slate-700 text-white px-5 py-3 rounded-full shadow-2xl flex items-center gap-3 transition-all duration-300 opacity-0 -translate-y-20 z-[60]">
        <i id="toast-icon" class="fa-solid fa-check text-emerald-500"></i>
        <span class="text-sm font-bold" id="toast-msg">Thông báo</span>
    </div>

    <script>
        const SUPABASE_URL = "https://sfbaytcmpgceapdcdyer.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmYmF5dGNtcGdjZWFwZGNkeWVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NDQ2MzYsImV4cCI6MjA4MTEyMDYzNn0.DeXO91pcCzQJHMcXTk9Eilcsk9IoGIPzOM-Ube4zRb8";
        const ADMIN_PASS = "admin123";
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // --- GLOBAL LOCK VARIABLE ---
        let isProcessing = false; // Khoá toàn cục để chống spam click

        // --- AUTH ---
        window.handleLogin = () => {
            if (document.getElementById("admin-pass").value === ADMIN_PASS) {
                document.getElementById("login-screen").classList.add("hidden");
                document.getElementById("main-app").classList.remove("hidden");
                loadAllData();
            } else showToast("Mật khẩu không đúng", "error");
        };

        window.loadAllData = async () => { await Promise.all([loadStats(), loadCodes(), loadWithdraws()]); };

        window.switchTab = (tab) => {
            ['dashboard', 'codes', 'withdraw', 'users'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                document.getElementById(`nav-${t}`).classList.remove('active');
            });
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`nav-${tab}`).classList.add('active');
            document.getElementById("page-title").innerText = {dashboard: "Tổng Quan", codes: "Quản Lý Code", withdraw: "Duyệt Đơn Rút", users: "Giao Dịch"}[tab];
            
            if(tab === 'withdraw') loadWithdraws();
            if(tab === 'codes' && document.getElementById("list-codes").children.length <= 1) loadCodes();
            if(tab === 'dashboard') loadStats();
        }

        window.formatInput = (input) => {
            let val = input.value.replace(/\D/g, '');
            input.value = val.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // --- STATS LOGIC ---
        async function loadStats() {
            try {
                const { count: pendingCount } = await db.from("withdraw_request").select("*", { count: 'exact', head: true }).eq("status", "pending");
                const { count: userCount } = await db.from("users").select("*", { count: 'exact', head: true });
                const { data: users } = await db.from("users").select("balance");
                const totalBalance = users ? users.reduce((sum, u) => sum + (u.balance || 0), 0) : 0;
                const { data: codes } = await db.from("codes_deposit").select("value, used_count");
                const totalIn = codes ? codes.reduce((sum, c) => sum + (c.value * c.used_count), 0) : 0;
                const { data: withdraws } = await db.from("withdraw_request").select("amount").eq("status", "approved");
                const totalOut = withdraws ? withdraws.reduce((sum, w) => sum + (w.amount || 0), 0) : 0;

                document.getElementById("stat-pending").innerText = pendingCount || 0;
                document.getElementById("stat-users").innerText = userCount || 0;
                document.getElementById("money-in").innerText = totalIn.toLocaleString() + ' đ';
                document.getElementById("money-out").innerText = totalOut.toLocaleString() + ' đ';
                document.getElementById("money-holding").innerText = totalBalance.toLocaleString() + ' đ';

                const badge = document.getElementById("badge-withdraw");
                if (pendingCount > 0) badge.classList.remove("hidden"); else badge.classList.add("hidden");
            } catch(e) { console.error("Stats Error:", e); }
        }

        // --- CODES LOGIC ---
        window.loadCodes = async () => {
            const list = document.getElementById("list-codes");
            const { data, error } = await db.from("codes_deposit").select("*").order("id", {ascending: false});
            
            if (error || !data || !data.length) { list.innerHTML = `<div class="text-center text-slate-500 text-xs italic py-10">Chưa có mã nào</div>`; return; }
            list.innerHTML = "";
            data.forEach(c => renderCodeItem(c, list));
        };

        function renderCodeItem(c, container, isNew = false) {
            const isExpired = c.expired || c.used_count >= c.max_use;
            const statusColor = isExpired ? 'text-rose-500' : 'text-emerald-500';
            const newBadge = isNew ? `<span class="bg-emerald-500 text-white text-[9px] px-1.5 py-0.5 rounded ml-2 font-bold animate-pulse">MỚI</span>` : '';
            const highlightClass = isNew ? 'highlight-new' : '';

            const html = `
                <div class="bg-slate-900 border border-slate-800 rounded-xl p-4 flex justify-between items-center ${isExpired ? 'opacity-60' : ''} ${highlightClass}">
                    <div class="flex-1">
                        <div class="flex items-center"><span class="text-white font-mono font-bold text-lg tracking-wider select-all">${c.code}</span>${newBadge}</div>
                        <div class="text-xs text-slate-400 mt-1 flex items-center gap-2"><i class="fa-solid fa-circle text-[6px] ${statusColor}"></i><span class="text-emerald-400 font-bold">${c.value.toLocaleString()}</span> coin • ${c.used_count}/${c.max_use}</div>
                    </div>
                    <button onclick="deleteCode('${c.code}', this)" class="w-10 h-10 rounded-full bg-slate-950 text-slate-500 hover:text-rose-500 flex items-center justify-center transition-colors active:scale-90"><i class="fa-solid fa-trash"></i></button>
                </div>`;
            if(isNew) container.insertAdjacentHTML('afterbegin', html); else container.insertAdjacentHTML('beforeend', html);
        }

        window.createDepositCode = async () => {
            const val = parseInt(document.getElementById("code-amount").value.replace(/,/g, ''));
            const max = parseInt(document.getElementById("code-max").value);
            if (!val) return showToast("Nhập giá trị!", "error");

            const code = Math.random().toString(36).substr(2, 6).toUpperCase();
            const { error } = await db.from("codes_deposit").insert({ code, value: val, max_use: max, used_count: 0, expired: false });

            if (error) { showToast("Lỗi tạo mã", "error"); } 
            else {
                showToast(`Đã tạo: ${code}`);
                document.getElementById("code-amount").value = "";
                const list = document.getElementById("list-codes");
                if(list.innerText.includes("Chưa có mã")) list.innerHTML = "";
                renderCodeItem({ code, value: val, max_use: max, used_count: 0, expired: false }, list, true);
                loadStats();
            }
        };

        window.deleteCode = async (code, btnElement) => {
            if(!confirm("Xóa mã này?")) return;
            const card = btnElement.closest('div.bg-slate-900');
            card.style.opacity = '0';
            setTimeout(() => card.remove(), 300);
            const { error } = await db.from("codes_deposit").delete().eq("code", code);
            if(error) { showToast("Lỗi xóa DB", "error"); loadCodes(); } else { showToast("Đã xóa"); loadStats(); }
        };

        // --- WITHDRAWS (MỚI: AN TOÀN & CHỐNG SPAM) ---
        window.loadWithdraws = async () => {
            const list = document.getElementById("list-withdraws");
            const { data } = await db.from("withdraw_request").select("*").eq("status", "pending").order("time_request", {ascending: false});
            document.getElementById("withdraw-count").innerText = (data?.length || 0) + " đơn";
            if (!data || !data.length) { list.innerHTML = `<div class="text-center text-slate-500 text-xs italic py-12">Không có yêu cầu nào</div>`; return; }

            list.innerHTML = "";
            data.forEach(w => {
                // SỬA HTML: Nút từ chối chỉ truyền ID
                list.innerHTML += `
                    <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 shadow-sm transition-all duration-300" id="wd-${w.id}">
                        <div class="flex justify-between items-start mb-3">
                            <div><h3 class="text-2xl font-bold text-white">${w.amount.toLocaleString()} <span class="text-sm font-normal text-slate-500">vnđ</span></h3><p class="text-[10px] text-slate-500 font-mono mt-0.5">${new Date(w.time_request).toLocaleString()}</p></div>
                            <span class="bg-blue-500/10 text-blue-500 px-2 py-1 rounded text-[10px] font-bold font-mono tracking-wide border border-blue-500/20">${w.uid}</span>
                        </div>
                        <div class="bg-slate-950 rounded-xl p-3 mb-4 space-y-2 border border-slate-800/50">
                            <div class="flex justify-between items-center text-xs"><span class="text-slate-500">Ngân hàng</span><span class="text-white font-bold">${w.bank_name}</span></div>
                            <div class="flex justify-between items-center text-xs"><span class="text-slate-500">Chủ TK</span><span class="text-white font-bold uppercase">${w.holder_name}</span></div>
                            <div class="flex justify-between items-center text-xs"><span class="text-slate-500">Số TK</span><span class="text-white font-mono font-bold tracking-wide select-all">${w.bank_account}</span></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="handleReject('${w.id}')" class="py-3 rounded-xl font-bold text-xs text-rose-500 bg-rose-950/30 border border-rose-900/50 hover:bg-rose-900/50 transition-colors">TỪ CHỐI</button>
                            <button onclick="handleApprove('${w.id}')" class="py-3 rounded-xl font-bold text-xs text-white bg-emerald-600 hover:bg-emerald-500 shadow-lg shadow-emerald-900/20 transition-colors">DUYỆT ĐƠN</button>
                        </div>
                    </div>`;
            });
        };

        // 1. AN TOÀN TUYỆT ĐỐI CHO APPROVE
        window.handleApprove = async (id) => {
            if (isProcessing) return; // Nếu đang xử lý thì chặn click
            if (!confirm("Xác nhận duyệt?")) return;

            isProcessing = true; // Bắt đầu khoá
            const card = document.getElementById(`wd-${id}`);
            if (card) card.classList.add("card-processing"); // Hiệu ứng xoay loading

            try {
                // Update DB trước
                const { error } = await db
                    .from("withdraw_request")
                    .update({ status: "approved", time_done: new Date().toISOString() })
                    .eq("id", id);

                if (error) throw error; // Nếu lỗi DB/RLS -> nhảy xuống catch

                // Thành công mới xóa UI
                if (card) {
                    card.style.transform = "translateX(100px)"; // Hiệu ứng lướt sang phải
                    card.style.opacity = "0";
                    setTimeout(() => card.remove(), 300);
                }
                showToast("Đã duyệt thành công");
                loadStats();
            } catch (e) {
                console.error(e);
                if (card) card.classList.remove("card-processing"); // Bỏ loading để ấn lại
                showToast("Duyệt thất bại (Lỗi DB/RLS)", "error");
            } finally {
                // Mở khoá sau 2s để tránh spam
                setTimeout(() => { isProcessing = false; }, 2000);
            }
        };

        // 2. AN TOÀN TUYỆT ĐỐI CHO REJECT (HOÀN TIỀN) - LOGIC MỚI
        window.handleReject = async (id) => {
            if (isProcessing) return;              // Chặn spam click
            if (!confirm("Từ chối và hoàn tiền?")) return;

            isProcessing = true;                   // Bắt đầu khoá
            const card = document.getElementById(`wd-${id}`);
            if (card) card.classList.add("card-processing"); // Hiệu ứng xoay loading

            try {
                // B0: Lấy lại thông tin đơn để chắc chắn (tránh truyền sai uid/amount)
                const { data: w, error: e0 } = await db
                    .from("withdraw_request")
                    .select("uid, amount, status")
                    .eq("id", id)
                    .single();

                if (e0 || !w) throw new Error("Không tìm thấy đơn rút.");
                if (w.status !== "pending") throw new Error("Đơn này đã được xử lý trước đó.");

                const uid = w.uid;
                const amount = Number(w.amount || 0);

                // B1: Lấy số dư hiện tại
                const { data: u, error: e1 } = await db
                    .from("users")
                    .select("balance")
                    .eq("id", uid)
                    .single();

                if (e1 || !u) throw new Error("Không tìm thấy user hoặc lỗi mạng.");

                const newBalance = (u.balance || 0) + amount;

                // B2: Hoàn tiền vào ví
                const { error: e2 } = await db
                    .from("users")
                    .update({ balance: newBalance })
                    .eq("id", uid);

                if (e2) throw new Error("Lỗi hoàn tiền (DB/RLS).");

                // B3: Đổi trạng thái đơn
                const { error: e3 } = await db
                    .from("withdraw_request")
                    .update({ status: "rejected", time_done: new Date().toISOString() })
                    .eq("id", id);

                if (e3) throw new Error("Tiền đã hoàn nhưng không update được đơn.");

                // Thành công mới xóa UI
                if (card) {
                    card.style.transform = "translateX(-100px)"; // Hiệu ứng lướt sang trái
                    card.style.opacity = "0";
                    setTimeout(() => card.remove(), 300);
                }

                showToast(`Đã hoàn tiền. Dư mới: ${newBalance.toLocaleString()}`);
                loadStats();
            } catch (err) {
                console.error(err);
                if (card) card.classList.remove("card-processing"); // Bỏ loading để ấn lại
                showToast(err.message || "Từ chối thất bại", "error");
            } finally {
                // Mở khoá sau 3s (reject quan trọng, khoá lâu hơn chút)
                setTimeout(() => { isProcessing = false; }, 3000);
            }
        };
        
        // --- USERS ---
        window.adjustBalance = async (type) => {
            const uid = document.getElementById("adjust-uid").value.trim().toUpperCase();
            const amountInput = document.getElementById("adjust-amount");
            const amount = parseInt(amountInput.value.replace(/,/g, ''));
            if (!uid || isNaN(amount) || amount <= 0) return showToast("Nhập thông tin hợp lệ", "error");

            const { data: user } = await db.from("users").select("*").eq("id", uid).maybeSingle();
            
            if (!user) {
                if (type === 'subtract') return showToast("User không tồn tại", "error");
                if(!confirm(`User ${uid} chưa có. Tạo mới và nạp ${amount.toLocaleString()}?`)) return;
                const { error: errIns } = await db.from("users").insert({ id: uid, balance: amount });
                if(errIns) showToast("Lỗi tạo user", "error"); else { showToast(`Đã tạo và nạp tiền`); amountInput.value = ""; loadStats(); }
                return;
            }

            let newBalance = user.balance;
            if (type === 'add') { newBalance += amount; } else {
                if (user.balance < amount) return showToast("Số dư không đủ để trừ", "error");
                newBalance -= amount;
            }

            const { error: errUp } = await db.from("users").update({ balance: newBalance }).eq("id", uid);
            if (errUp) { showToast("Lỗi cập nhật", "error"); } else {
                showToast(`${type === 'add' ? 'Nạp' : 'Trừ'} thành công. Dư: ${newBalance.toLocaleString()}`);
                amountInput.value = "";
                loadStats();
            }
        };

        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            const icon = document.getElementById('toast-icon');
            icon.className = type === 'error' ? "fa-solid fa-triangle-exclamation text-rose-500" : "fa-solid fa-check text-emerald-500";
            t.classList.remove('opacity-0', '-translate-y-20');
            setTimeout(() => t.classList.add('opacity-0', '-translate-y-20'), 3000);
        }
    </script>
</body>
</html>

